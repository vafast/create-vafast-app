---
description: Vafast 框架开发规则 - 高性能、类型安全的 TypeScript Web 框架
globs: ["**/*.ts", "**/*.tsx"]
alwaysApply: true
---

# Vafast 开发规则

你正在开发一个使用 Vafast 框架的 TypeScript 项目。请遵循以下规则：

## 核心原则

1. **类型安全优先** - 使用 TypeBox 定义 schema，让类型自动推断
2. **函数式风格** - 优先使用函数而非 class
3. **Go 风格错误处理** - 返回 `{ data, error }` 而非抛出异常
4. **HTTP 状态码** - 错误必须使用正确的 HTTP 状态码
5. **模块化** - 功能分离，每个函数职责单一

## 路由定义

```typescript
// ✅ 正确：使用 defineRoute 定义路由
import { defineRoute, defineRoutes, Type } from 'vafast'

const routes = defineRoutes([
  defineRoute({
    method: 'GET',
    path: '/users',
    name: 'get_users',           // 用于 AI tools 和文档
    description: '获取用户列表',   // 描述接口功能
    schema: {
      query: Type.Object({
        page: Type.Number(),
        limit: Type.Optional(Type.Number()),
      })
    },
    handler: ({ query }) => ({
      users: [],
      page: query.page,
    })
  })
])

// ❌ 错误：不要使用裸对象定义路由
const badRoutes = [
  { method: 'GET', path: '/users', handler: () => {} }  // 缺少类型推断
]
```

## Schema 定义

```typescript
import { Type } from 'vafast'

// ✅ 正确：使用 TypeBox 类型
const UserSchema = Type.Object({
  id: Type.String(),
  name: Type.String(),
  email: Type.String({ format: 'email' }),
  age: Type.Optional(Type.Number()),
})

// schema 支持的字段
schema: {
  body: Type.Object({...}),    // POST/PUT 请求体
  query: Type.Object({...}),   // GET 查询参数
  params: Type.Object({...}),  // 路径参数 /users/:id
  headers: Type.Object({...}), // 请求头
  cookies: Type.Object({...}), // Cookie
}
```

## Handler 上下文

```typescript
handler: ({ body, query, params, headers, cookies, request }) => {
  // body    - 请求体（已验证和类型推断）
  // query   - 查询参数
  // params  - 路径参数
  // headers - 请求头
  // cookies - Cookie
  // request - 原始 Request 对象
  
  return { ... }  // 直接返回对象，自动序列化为 JSON
}
```

## 中间件

```typescript
import { defineMiddleware } from 'vafast'

// 定义带类型的中间件
const authMiddleware = defineMiddleware<{ user: User }>(async (req, next) => {
  const token = req.headers.get('Authorization')
  const user = await verifyToken(token)
  return next({ user })  // 传递上下文给 handler
})

// 在路由中使用
defineRoute({
  method: 'GET',
  path: '/profile',
  middleware: [authMiddleware],
  handler: ({ user }) => ({  // user 类型自动推断
    id: user.id,
    name: user.name,
  })
})
```

## 错误处理（最佳实践）

使用 HTTP 状态码 + `{ code, message }` 格式：

```typescript
import { err } from 'vafast'

// ✅ 正确：使用 err() 抛出错误
handler: ({ params }) => {
  const user = db.findUser(params.id)
  if (!user) {
    throw err.notFound('用户不存在')  // HTTP 404
  }
  if (!user.active) {
    throw err.forbidden('账号已禁用', 10001)  // HTTP 403, code: 10001
  }
  return user
}

// 预定义错误
throw err.badRequest('参数错误')       // 400
throw err.unauthorized('请先登录')    // 401
throw err.forbidden('无权限')          // 403
throw err.notFound('不存在')           // 404

// 自定义业务码
throw err.notFound('用户不存在', 10001)  // HTTP 404, { code: 10001, message: "用户不存在" }

// ❌ 错误：不要返回 200 + success: false
handler: () => {
  return { success: false, message: '错误' }  // 状态码仍是 200！
}
```

**错误响应格式：**

```json
HTTP 404 Not Found

{
  "code": 10001,
  "message": "用户不存在"
}
```

## SSE 流式响应

```typescript
import { createSSEHandler } from 'vafast'

defineRoute({
  method: 'GET',
  path: '/chat/stream',
  handler: createSSEHandler(async function* ({ query }) {
    yield { event: 'start', data: { message: '开始' } }
    
    for await (const chunk of aiStream(query.prompt)) {
      yield { data: { text: chunk } }
    }
    
    yield { event: 'end', data: { message: '完成' } }
  })
})
```

## 嵌套路由

```typescript
defineRoute({
  path: '/api/v1',
  middleware: [apiKeyMiddleware],
  children: [
    defineRoute({
      method: 'GET',
      path: '/users',
      handler: () => []
    }),
    defineRoute({
      method: 'POST',
      path: '/users',
      schema: { body: CreateUserSchema },
      handler: ({ body }) => ({ id: '1', ...body })
    })
  ]
})
// 生成：GET /api/v1/users, POST /api/v1/users
```

## API 客户端（@vafast/api-client）

```typescript
import { createClient, eden, InferEden } from '@vafast/api-client'

// 创建客户端
const client = createClient('http://localhost:3000')
  .headers({ 'Authorization': 'Bearer token' })
  .timeout(30000)

// 类型推断
type Api = InferEden<typeof routes>
const api = eden<Api>(client)

// 调用
const { data, error } = await api.users.get({ page: 1 })
if (error) {
  console.error(`错误 ${error.code}: ${error.message}`)
  return
}
```

## 禁止事项

1. ❌ 不要使用 `as` 类型断言（除非调用第三方库）
2. ❌ 不要使用 class 定义路由或服务
3. ❌ 不要手动 JSON.parse/stringify 请求体（框架自动处理）
4. ❌ 不要使用 try-catch 包裹所有代码（框架有全局错误处理）
5. ❌ 不要创建不必要的类型导出文件
6. ❌ 不要返回 200 + `{ success: false }` 格式错误
